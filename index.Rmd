--- 
title: "Poverty and Inequality with Complex Survey Data"
author: "By Guilherme Jacob, Anthony Damico, and Djalma Pessoa.  The authors received no external funding for the `convey` software and this accompanying textbook."
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::tufte_html_book:
    toc: yes
    css: toc.css
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apa
link-citations: yes
github-repo: guilhermejacob/context
description: "A book about the R convey package"
delete_merged_file: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  cache=TRUE, cache.lazy=FALSE
)
```

```{r results='hide', echo=FALSE}
set.seed(2017)

```

# Intro

The R `convey` library estimates measures of poverty, inequality, and wellbeing.  There are two other R libraries covering this subject, [vardpoor](https://CRAN.R-project.org/package=vardpoor) [@R-vardpoor] and [laeken](https://CRAN.R-project.org/package=laeken) [@R-laeken], however, only `convey` integrates seamlessly with the [R survey package](https://CRAN.R-project.org/package=survey) [@R-survey-article;@R-survey-book;@R-survey].

`convey` is free and open-source software that runs inside the [R environment for statistical computing](https://www.r-project.org/).  Anyone can review and propose changes to [the source code](https://github.com/ajdamico/convey) for this software.  Readers are welcome to [propose changes to this book](https://github.com/guilhermejacob/context/) as well.

As a companion guide, this flowchart clarifies the various options in this software:

[![](https://mermaid.ink/img/pako:eNrtWv1zFDcS_VdUW0nZVK1d2IBJXEcog8GYz5wxAXK-utLOaHcVz4wmkmbXi83_fq9b0uzshw0V6i4_JJUimBmN9Pp19-tuwWUvM7nq7ffOqpGV9VicHp5V-M8f_Ousd2jEzDRiLCdKSJGZsi7UhXCSfheusRM1E7lyelQJM_hNZV5kVkmvcjHVfiwU_qescJNZWLR5Sxj6o1V1--DhWe_fdBwfKba2fhJXr82VeITTTyR_7seywtkVDuvT707n_FSJQqpzVdGeE2nz2uCHE1HogZVWK7e68UflrsRj7PzeNEXOphX6XAlvxES7Rhb6kxK6Ur_Tj37Whfa4s8MhdoBNhbGq-gQTamsmwORAkfNW6tHYD42dApJgSnUmzFCMzfQfA_sTDrWiNnVTSK9NRW905ZVVzotcD4fKOjG0phS1skNiNKFZBUM8PQGWA6uCLcac62okcDhByYBPbDpd6kJaspEoG-lKg0Q1HOpMq8rfIkxwbGmqYiYaB9cNZkCER4rIzrDGBqSAqKTN4BLXp68GjSffeFGSxaIyXgyUUNJp2qmCk5w3hvfjk1WlrCxE3QwKnXW5fZLM6YtjUSlAcB5HOq8zR7hBbWb1gEKwQ5y6qLGP9jgMaySCYSZkk8OoTF2Jpx1e1IUsYTaYqc1EWT-jiFl185PWxYRDlkt8UvRbNVaIP2RDCTsb7M_uWyWL-FETxKYesvGZLLIEXFa50N4Ft2NLHx4HFgeKPqVA0PjA89mr7JHFkWHsdiWOVmMaAQDslKaJy3YvoNQ25S_YnpMaqQAZTwMZPwfCrsSzDp8pXvGprpiXxhNPsuXXj_F-bIqcjNmkc8kHEI0-A0jLCjiBA5AIXrs5czeWVmZ4GiKC1w_jPm00sN4UZqps9IdLbg2WHF8etw7_nALvGb96fnma4PKb5_z0RUhyaWuPFA9GIsXp2NY68r6kUwX7AQkfwRV6QoREdqBGDhBTBkZPxjXpy7ldxpEICRaKpLHSS6c8s4lQKkAObSX9FrY-3zLDrRXmb3USLNj58vKs93iRy7Ney8VLXvMKVm88g0GlrGbsE5JghPmEMBcPNwhCoMUu0-LGMiTEomvoi2jrQBFXX0IegQdArxOgPLCnCkQ9Uj7wytKNPLMzU9E7p1qEttTLCOkNpyeBLFWuUVdi8pohvayVocImB4AkJi7iReoDoIRL5EgtgHuTwA00nB1YGMm6z5GrbOnooNwU0F8nNhHkhgta1lhUjmx2qwO2Hi3TaRXxByChKpCsseoqP1UqZMayDSIawLhp8ZeopjUkR4tRDXFSxXDB0p_buGiycTowNxFqxFE15QDmcQSAjTUHj6xpam4nWtOpauP7ZesXTZMoT5ROOeIoRxK7PxpU9OuYLfpnyO_RVxM_V_rkglIFMZ_iYRUPCJufhM1_dytJ0sZf3AsVtVLsh1gmvanF7u3vEWuIOOf52dzB9KeB8R79ARYltca5R3zuW5wb69dUVn5dEUDCxNxh58dTYqfGaSxLQuGp2Cwk8SZKfQhgr7EE_Yk2ueOWLm0TXq8pLKkZCzBPATNU-ykXrdSElfJcdRSTvUzCrgPP3dB3zYCDKclmOVt3bIegt3zyu5vagn6nKeizWcNh0ZD_u93KO97oF4hpLI4dEf2F370P3h-O_KbY3t4WfTESD8TtpUgYK5lnpoGXUrAiNhR3Vql5ayogQA8YmrKBAlZ6_d0Ogftu5_btTvB3a2pEG9B8WItmZ1UaJWn8SKGRsyW3wnm7KYkaOwO97Fh4uInbF7RdWTCBEOSaalmmUqHrItrvyOsNwOOkQYvHaIeUbd8GQngU4AoZeLhun21B76FXVBv6sYZBkpABRYFYEgpBlVGEWzMoVLkfmq7r8dPHkn9CKz1sqoyia5u-OiWpQzdYudAMo-Gj4CKOBFRLzWgRN_RhT8OdPoXziDRGgzuTpLpQzvESsUlhbxqap4xz0e8rrVN_-WnqSltTU0IvRMTHtRGxe31EOCSFRTjcGBkqNAuxelo1gqHcKqMlrhyENGQzQOEFtbac1aRtGBldUjeOk0VrtsVxFZVlatAo8XkjWZbywW6MxY154tK2cYONhRhdoODXQMFUeu-6Ei1bCoMMSUQHkxxC4usISbKF3Ugpt7zZUhfat0VpsfHn2ONmXjhS-c2mAiEFq3Vf0JCFqWzYFLeEdK4pa5bTfghYVEPSL4L2nkxp0UMuOtWzqsANFd8pQJHKiBMeRTW6Kbdg2LyEzxDpLK7UvRdKTrrzE5WTxm2vqOLVvMm-EgcH18-mJtNANEWbQU1cSqiHdF68c5hqN-bBzvH1gkyL-9CIuoa_nWONdlTYhpK_FxMJvY7-kpxgFfUOpFBUIygdWcp9ezEQbgZOTy-pInWU_OBgeRpcHEyutaHPoyJkpMZgTJo19zZiiftVvDYl_OuuxEnsFKQ_X-4UDjwIo7kBbY-66Ad_tlGeHJ1jkstoBuauheaCEKmltBj1gQ-jGX-Q7J-LVncmxTBN6RqP1rmScbQnC_i7-S0HP2u9QQEqqdPINVVTNyYvU4zxQW9NkPuS05T1bd5VEY8U8th-w7VESsYAC0lG0C12GiBSaKtxIonvakmmmnyCAkWxQaFxkMp3t0KH_H9DrTtkJQ5jYSzFcHRu5URyhKMpx1ZJIP2sVv9JnD8QG1i6IW6RzoJ-U6L_y1XOFgd6w3UAsqqPnEH7rz8xz1uOrg-4ubQJaNzVpVHgy6dS8fjCyqdHp6c7WMuNJbRzLrNRmODNFYGObTa3qdh7u2PKhCJwHn5r7PgK-ARqlwzIVUb1C3I79HQsi_5XAOq4_M2b0GpRr_WU7jXWE0BUxXP7axDe3Jdxr_6lhkx0urFQ-hJc9u7SADJH_u7dNyPfWZ4t0qE8g35dr3YT5JWm7abF6ZI49m3tguXGjXa6caM1Xv7w4RquKCGuZUfcQE8QVeIItqVWE-W-VAjIOF2igVuz7R1s6xXNzIZveNeETNeC01O24NGjOG5CIpeFfvlKNkZcupTd4ktZrmzdy1C-YQyVJOsWBpbtqaLLRIhg4wtNN8r8ukh3yBHU48cRlNLJQlU7XaAeIC3Eaj8IMdDF1su2IrVVaC4HoZmda7xrc9gk8Vm4pVtEdHh4A6KdaxGdfiOiGABrIT15EiD9hm5r2XPPt_BQ2REXs3hye1UwnyTnqCrDd3jURaFkdzG2E7jURSd8GAjjePoHbrT5-jPcfx4drR1Yj8JA_uxZOxJAm__cqTVAOj6-DtHfk-tfcXKNgfr8-XVh8RcZXyMPL150Blhi4u8Z9ttn2CXJfEl_YTIfaLt_VxL_suRVW606wfhnldAI6vXrm0H9n6toRPXx47yKLoXr_76Q9vq9UiHIdd7b712eVUKc9bCGtGUfP-ZqKJHQZ72z6jOWysabt7Mq6-1726h-r6lzRNuhliO0h-mhyrU39lX4lxP8Dyj6vVpWvxrTLsEfe_uXvYve_s72vb07e3d27t25e-_-3t2dvX5v1tvf_XFv-86PP9y_u7t3_979H3Z2733u9z7xBjuf_wuh1epF?type=png)](https://mermaid.live/view#pako:eNrtWv1zFDcS_VdUW0nZVK1d2IBJXEcog8GYz5wxAXK-utLOaHcVz4wmkmbXi83_fq9b0uzshw0V6i4_JJUimBmN9Pp19-tuwWUvM7nq7ffOqpGV9VicHp5V-M8f_Ousd2jEzDRiLCdKSJGZsi7UhXCSfheusRM1E7lyelQJM_hNZV5kVkmvcjHVfiwU_qescJNZWLR5Sxj6o1V1--DhWe_fdBwfKba2fhJXr82VeITTTyR_7seywtkVDuvT707n_FSJQqpzVdGeE2nz2uCHE1HogZVWK7e68UflrsRj7PzeNEXOphX6XAlvxES7Rhb6kxK6Ur_Tj37Whfa4s8MhdoBNhbGq-gQTamsmwORAkfNW6tHYD42dApJgSnUmzFCMzfQfA_sTDrWiNnVTSK9NRW905ZVVzotcD4fKOjG0phS1skNiNKFZBUM8PQGWA6uCLcac62okcDhByYBPbDpd6kJaspEoG-lKg0Q1HOpMq8rfIkxwbGmqYiYaB9cNZkCER4rIzrDGBqSAqKTN4BLXp68GjSffeFGSxaIyXgyUUNJp2qmCk5w3hvfjk1WlrCxE3QwKnXW5fZLM6YtjUSlAcB5HOq8zR7hBbWb1gEKwQ5y6qLGP9jgMaySCYSZkk8OoTF2Jpx1e1IUsYTaYqc1EWT-jiFl185PWxYRDlkt8UvRbNVaIP2RDCTsb7M_uWyWL-FETxKYesvGZLLIEXFa50N4Ft2NLHx4HFgeKPqVA0PjA89mr7JHFkWHsdiWOVmMaAQDslKaJy3YvoNQ25S_YnpMaqQAZTwMZPwfCrsSzDp8pXvGprpiXxhNPsuXXj_F-bIqcjNmkc8kHEI0-A0jLCjiBA5AIXrs5czeWVmZ4GiKC1w_jPm00sN4UZqps9IdLbg2WHF8etw7_nALvGb96fnma4PKb5_z0RUhyaWuPFA9GIsXp2NY68r6kUwX7AQkfwRV6QoREdqBGDhBTBkZPxjXpy7ldxpEICRaKpLHSS6c8s4lQKkAObSX9FrY-3zLDrRXmb3USLNj58vKs93iRy7Ney8VLXvMKVm88g0GlrGbsE5JghPmEMBcPNwhCoMUu0-LGMiTEomvoi2jrQBFXX0IegQdArxOgPLCnCkQ9Uj7wytKNPLMzU9E7p1qEttTLCOkNpyeBLFWuUVdi8pohvayVocImB4AkJi7iReoDoIRL5EgtgHuTwA00nB1YGMm6z5GrbOnooNwU0F8nNhHkhgta1lhUjmx2qwO2Hi3TaRXxByChKpCsseoqP1UqZMayDSIawLhp8ZeopjUkR4tRDXFSxXDB0p_buGiycTowNxFqxFE15QDmcQSAjTUHj6xpam4nWtOpauP7ZesXTZMoT5ROOeIoRxK7PxpU9OuYLfpnyO_RVxM_V_rkglIFMZ_iYRUPCJufhM1_dytJ0sZf3AsVtVLsh1gmvanF7u3vEWuIOOf52dzB9KeB8R79ARYltca5R3zuW5wb69dUVn5dEUDCxNxh58dTYqfGaSxLQuGp2Cwk8SZKfQhgr7EE_Yk2ueOWLm0TXq8pLKkZCzBPATNU-ykXrdSElfJcdRSTvUzCrgPP3dB3zYCDKclmOVt3bIegt3zyu5vagn6nKeizWcNh0ZD_u93KO97oF4hpLI4dEf2F370P3h-O_KbY3t4WfTESD8TtpUgYK5lnpoGXUrAiNhR3Vql5ayogQA8YmrKBAlZ6_d0Ogftu5_btTvB3a2pEG9B8WItmZ1UaJWn8SKGRsyW3wnm7KYkaOwO97Fh4uInbF7RdWTCBEOSaalmmUqHrItrvyOsNwOOkQYvHaIeUbd8GQngU4AoZeLhun21B76FXVBv6sYZBkpABRYFYEgpBlVGEWzMoVLkfmq7r8dPHkn9CKz1sqoyia5u-OiWpQzdYudAMo-Gj4CKOBFRLzWgRN_RhT8OdPoXziDRGgzuTpLpQzvESsUlhbxqap4xz0e8rrVN_-WnqSltTU0IvRMTHtRGxe31EOCSFRTjcGBkqNAuxelo1gqHcKqMlrhyENGQzQOEFtbac1aRtGBldUjeOk0VrtsVxFZVlatAo8XkjWZbywW6MxY154tK2cYONhRhdoODXQMFUeu-6Ei1bCoMMSUQHkxxC4usISbKF3Ugpt7zZUhfat0VpsfHn2ONmXjhS-c2mAiEFq3Vf0JCFqWzYFLeEdK4pa5bTfghYVEPSL4L2nkxp0UMuOtWzqsANFd8pQJHKiBMeRTW6Kbdg2LyEzxDpLK7UvRdKTrrzE5WTxm2vqOLVvMm-EgcH18-mJtNANEWbQU1cSqiHdF68c5hqN-bBzvH1gkyL-9CIuoa_nWONdlTYhpK_FxMJvY7-kpxgFfUOpFBUIygdWcp9ezEQbgZOTy-pInWU_OBgeRpcHEyutaHPoyJkpMZgTJo19zZiiftVvDYl_OuuxEnsFKQ_X-4UDjwIo7kBbY-66Ad_tlGeHJ1jkstoBuauheaCEKmltBj1gQ-jGX-Q7J-LVncmxTBN6RqP1rmScbQnC_i7-S0HP2u9QQEqqdPINVVTNyYvU4zxQW9NkPuS05T1bd5VEY8U8th-w7VESsYAC0lG0C12GiBSaKtxIonvakmmmnyCAkWxQaFxkMp3t0KH_H9DrTtkJQ5jYSzFcHRu5URyhKMpx1ZJIP2sVv9JnD8QG1i6IW6RzoJ-U6L_y1XOFgd6w3UAsqqPnEH7rz8xz1uOrg-4ubQJaNzVpVHgy6dS8fjCyqdHp6c7WMuNJbRzLrNRmODNFYGObTa3qdh7u2PKhCJwHn5r7PgK-ARqlwzIVUb1C3I79HQsi_5XAOq4_M2b0GpRr_WU7jXWE0BUxXP7axDe3Jdxr_6lhkx0urFQ-hJc9u7SADJH_u7dNyPfWZ4t0qE8g35dr3YT5JWm7abF6ZI49m3tguXGjXa6caM1Xv7w4RquKCGuZUfcQE8QVeIItqVWE-W-VAjIOF2igVuz7R1s6xXNzIZveNeETNeC01O24NGjOG5CIpeFfvlKNkZcupTd4ktZrmzdy1C-YQyVJOsWBpbtqaLLRIhg4wtNN8r8ukh3yBHU48cRlNLJQlU7XaAeIC3Eaj8IMdDF1su2IrVVaC4HoZmda7xrc9gk8Vm4pVtEdHh4A6KdaxGdfiOiGABrIT15EiD9hm5r2XPPt_BQ2REXs3hye1UwnyTnqCrDd3jURaFkdzG2E7jURSd8GAjjePoHbrT5-jPcfx4drR1Yj8JA_uxZOxJAm__cqTVAOj6-DtHfk-tfcXKNgfr8-XVh8RcZXyMPL150Blhi4u8Z9ttn2CXJfEl_YTIfaLt_VxL_suRVW606wfhnldAI6vXrm0H9n6toRPXx47yKLoXr_76Q9vq9UiHIdd7b712eVUKc9bCGtGUfP-ZqKJHQZ72z6jOWysabt7Mq6-1726h-r6lzRNuhliO0h-mhyrU39lX4lxP8Dyj6vVpWvxrTLsEfe_uXvYve_s72vb07e3d27t25e-_-3t2dvX5v1tvf_XFv-86PP9y_u7t3_979H3Z2733u9z7xBjuf_wuh1epF)



Individuals getting started in the field of poverty and inequality statistics might find the number of techniques described in this textbook overwhelming, especially choosing which method might be most appropriate for each particular research question.  The authors of this textbook consider Dr. Ija Trapeznikova's article [Measuring income inequality](https://wol.iza.org/articles/measuring-income-inequality/long) an important summary of how to approach selecting between available techniques.




## Installation {#install}

In order to work with the `convey` library, you will need to have R running on your machine.  If you have never used R before, you will need to [install that software](https://www.r-project.org/) before `convey` can be accessed.  Once you have R loaded on your machine, you can install..

* the latest released version from [CRAN](https://CRAN.R-project.org/package=convey) with

```R
install.packages("convey")
```

* the latest development version from github with

```R
remotes::install_github("ajdamico/convey")
```

In order to know how to cite this package, run `citation("convey")`.

## Complex surveys and statistical inference {#survey}

In this book, we demonstrate how to measure poverty and income concentration in a population based on microdata collected from a complex survey sample.  Most surveys administered by government agencies or larger research organizations utilize a sampling design that violates the assumption of simple random sampling (SRS), including:

1. Different units selection probabilities;
2. Clustering of units;
3. Stratification of clusters;
4. Reweighting to compensate for missing values and other adjustments.

Therefore, basic unweighted R commands such as `mean()` or `glm()` will not properly account for the weighting nor the measures of uncertainty (such as the confidence intervals) present in the dataset.  For some examples of publicly-available complex survey data sets, see [http://asdfree.com]().  

Unlike other software, the R `convey` package does not require that the user specify these parameters throughout the analysis.  So long as the [svydesign object](http://r-survey.r-forge.r-project.org/survey/html/svydesign.html) or [svrepdesign object](http://r-survey.r-forge.r-project.org/survey/html/svrepdesign.html) has been constructed properly at the outset of the analysis, the `convey` package will incorporate the survey design automatically and produce statistics and variances that take the complex sample into account.

Survey analysts familiar with the R `dplyr` syntax implemented by the `survey` library's wrapper `srvyr` package might be interested in implementing specific `convey` functions by following the [`svygini()` example](http://gdfe.co/srvyr/articles/extending-srvyr.html) published by `srvyr` author Greg Freedman Ellis.  Note that the full design stored by `convey_prep()` may in some cases complicate this extension.


## Usage Examples


In the following example, we've loaded the data set `eusilc` from the R library [laeken](https://CRAN.R-project.org/package=laeken) [@R-laeken].

```{r results='hide', message=FALSE, warning=FALSE}
library(laeken)
data(eusilc)
```
Next, we create an object of class `survey.design` using the function `svydesign` of the `survey` library:

```{r results='hide', message=FALSE, warning=FALSE}
library(survey)
des_eusilc <-
  svydesign(
    ids = ~ rb030,
    strata =  ~ db040,
    weights = ~ rb050,
    data = eusilc
  )
```
Right after the creation of the design object `des_eusilc`, we should use the function `convey_prep` that adds an attribute to the survey design which saves information on the design object based upon the whole sample, needed to work with subset designs.

```{r}
library(convey)
des_eusilc <- convey_prep(des_eusilc)
```
To estimate the at-risk-of-poverty rate, we use the function `svyarpt`:

```{r comment=NA}
svyarpr( ~ eqIncome, design = des_eusilc)
```
To estimate the at-risk-of-poverty rate across domains defined by the variable `db040` we use:

```{r comment=NA}
svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc,
  FUN = svyarpr,
  deff = FALSE
)
```

Using the same data set, we estimate the quintile share ratio: 

```{r comment=NA}
# for the whole population
svyqsr( ~ eqIncome, design = des_eusilc, alpha1 = .20)

# for domains
svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc,
  FUN = svyqsr,
  alpha1 = .20,
  deff = FALSE
)
```

These functions can be used as S3 methods for the classes `survey.design` and `svyrep.design`.

Let's create a design object of class `svyrep.design` and run the function `convey_prep` on it:

```{r}
des_eusilc_rep <- as.svrepdesign(des_eusilc, type = "bootstrap")
des_eusilc_rep <- convey_prep(des_eusilc_rep)
```

The function `svyarpr` produces matching coefficients and near-identical standard errors on the replication design:

```{r comment=NA}
svyarpr( ~ eqIncome, design = des_eusilc_rep)

svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc_rep,
  FUN = svyarpr,
  deff = FALSE
)
```
The functions of the convey `library` are called in a similar way  to the functions in `survey` library.

It is also possible to deal with missing values by using the argument `na.rm`.

```{r comment=NA}
# survey.design using a variable with missings
svygini( ~ py010n , design = des_eusilc)
svygini( ~ py010n , design = des_eusilc , na.rm = TRUE)

# svyrep.design using a variable with missings
svygini( ~ py010n , design = des_eusilc_rep)
svygini( ~ py010n , design = des_eusilc_rep , na.rm = TRUE)
```


## The Current Population Survey (CPS)

Sponsored jointly by the U.S. Census Bureau and the U.S. Bureau of Labor Statistics (BLS), the Current Population Survey is the primary source of labor force statistics for the population of the United States.

This section downloads, imports, and prepares the most current microdata for analysis.


Download and unzip the 2023 file:

```{r}
library(httr)

tf <- tempfile()

this_url <-
  "https://www2.census.gov/programs-surveys/cps/datasets/2023/march/asecpub23sas.zip"

GET(this_url , write_disk(tf) , progress())

unzipped_files <- unzip(tf , exdir = tempdir())
```

Import all four files:

```{r}
library(haven)

four_tbl <- lapply(unzipped_files , read_sas)

four_df <- lapply(four_tbl , data.frame)

four_df <-
  lapply(four_df , function(w) {
    names(w) <- tolower(names(w))
    w
  })

household_df <-
  four_df[[grep('hhpub' , basename(unzipped_files))]]
family_df <-
  four_df[[grep('ffpub' , basename(unzipped_files))]]
person_df <-
  four_df[[grep('pppub' , basename(unzipped_files))]]
repwgts_df <-
  four_df[[grep('repwgt' , basename(unzipped_files))]]
```

Divide weights:

```{r}
household_df[, 'hsup_wgt'] <- household_df[, 'hsup_wgt'] / 100
family_df[, 'fsup_wgt'] <- family_df[, 'fsup_wgt'] / 100
for (j in c('marsupwt' , 'a_ernlwt' , 'a_fnlwgt'))
  person_df[, j] <- person_df[, j] / 100
```

Merge these four files:

```{r}
names(family_df)[names(family_df) == 'fh_seq'] <- 'h_seq'
names(person_df)[names(person_df) == 'ph_seq'] <- 'h_seq'
names(person_df)[names(person_df) == 'phf_seq'] <- 'ffpos'

hh_fm_df <- merge(household_df , family_df)
hh_fm_pr_df <- merge(hh_fm_df , person_df)
cps_df <- merge(hh_fm_pr_df , repwgts_df)

stopifnot(nrow(cps_df) == nrow(person_df))
```

Construct a complex sample survey design:

```{r}
library(survey)

cps_design <-
  svrepdesign(
    weights = ~ marsupwt ,
    repweights = "pwwgt[1-9]" ,
    type = "Fay" ,
    rho = (1 - 1 / sqrt(4)) ,
    data = cps_df ,
    combined.weights = TRUE ,
    mse = TRUE
  )
```

Run the `convey_prep()` function on the full design:

```{r}
cps_design <- convey_prep(cps_design)
```

### Household-level Analysis of the CPS

Limit the CPS person-level design to the household reference person, then calculate the gini coefficient with total household income:

```{r}
cps_household_design <- subset(cps_design , a_exprrp %in% 1:2)

(cps_household_gini <- svygini(~ htotval , cps_household_design))

# match 2022 household gini coefficient
# https://www2.census.gov/programs-surveys/cps/tables/time-series/historical-income-households/h04.xlsx
stopifnot(round(coef(cps_household_gini) , 3) == 0.488)

# match 2022 household gini margin of error
# https://www.census.gov/content/dam/Census/newsroom/press-kits/2023/iphi/20230912-iphi-slides-income.pdf#page=13
stopifnot(round(
  coef(cps_household_gini) - confint(cps_household_gini , level = 0.9)[1] ,
  4
) == 0.0033) 
```

### Family-level Analysis of the CPS

Limit the CPS person-level design to the family reference person of primary families, then calculate the gini coefficient with total family income:

```{r}
cps_family_design <-
  subset(cps_design , a_famrel %in% 1 & a_famtyp %in% 1)

(cps_family_gini <- svygini(~ ftotval , cps_family_design))

# match 2022 family gini coefficient
# https://www2.census.gov/programs-surveys/cps/tables/time-series/historical-income-families/f04.xlsx
stopifnot(round(coef(cps_family_gini) , 3) == 0.458)
```

### Full-time Full Year Worker Analysis of the CPS

Limit the CPS person-level design to full-time, full year workers, then calculate the gini coefficient with both total personal income and then total earnings:

```{r}
cps_ftfy_worker_design <- subset(cps_design , wewkrs %in% 1)

svygini(~ ptotval , cps_ftfy_worker_design)

svygini(~ pearnval , cps_ftfy_worker_design)
```
