--- 
title: "Poverty and Inequality with Complex Survey Data"
author: "Guilherme Jacob, Anthony Damico, and Djalma Pessoa"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::tufte_html_book:
    toc: yes
    css: toc.css
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apa
link-citations: yes
github-repo: guilhermejacob/context
description: "A book about the R convey package"
delete_merged_file: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  cache=TRUE, cache.lazy=FALSE
)
```

```{r results='hide', echo=FALSE}
set.seed(2017)

```

# Introduction

The R `convey` library estimates measures of poverty, inequality, and wellbeing.  There are two other R libraries covering this subject, [vardpoor](https://CRAN.R-project.org/package=vardpoor) [@R-vardpoor] and [laeken](https://CRAN.R-project.org/package=laeken) [@R-laeken], however, only `convey` integrates seamlessly with the [R survey package](https://CRAN.R-project.org/package=survey) [@R-survey-article;@R-survey-book;@R-survey].

`convey` is free and open-source software that runs inside the [R environment for statistical computing](https://www.r-project.org/).  Anyone can review and propose changes to [the source code](https://github.com/ajdamico/convey) for this software.  Readers are welcome to [propose changes to this book](https://github.com/guilhermejacob/context/) as well.

As a companion guide, this flowchart clarifies the various options in this software:


[![](https://mermaid.ink/img/pako:eNrtWv1zFDcS_VdUW0nZVK1dtgkEXEcog8GYz5wxAXK-utLOaHcVz4wmkmbXi83_fq9b0uzshw0V6i4_JJUimBmN9Pp19-tuwWUvM7nq7ffOqpGV9VicHp5V-M8f_Ousd2jEzDRiLCdKSJGZsi7UhXCSfheusRM1E7lyelQJM_hNZV5kVkmvcjHVfiwU_qescJNZWLR5Sxj6o1V1--DhWe_fdBwfKba2fhJXr82VeITTTyR_7seywtkVDuvT707n_FSJQqpzVdGeE2nz2uCHE1HogZVWK7e68UflrsRj7PzeNEXOphX6XAlvxES7Rhb6kxK6Ur_Tj37Whfa4s8MhdoBNhbGq-gQTamsmwORAkfNW6tHYD42dApJgSnUmzFCMzfQfA_sTDrWiNnVTSK9NRW905ZVVzotcD4fKOjG0phS1skNiNKFZBUM8PQGWA6uCLcac62okcDhByYBPbDpd6kJaspEoG-lKg0Q1HOpMq8rfIkxwbGmqYiYaB9cNZkCER4rIzrDGBqSAqKTN4BLXp68GjSffeFGSxaIyXgyUUNJp2qmCk5w3hvfjk1WlrCxE3QwKnXW5fZLM6YtjUSlAcB5HOq8zR7hBbWb1gEKwQ5y6qLGP9jgMaySCYSZkk8OoTF2Jpx1e1IUsYTaYqc1EWT-jiFl185PWxYRDlkt8UvRbNVaIP2RDCTsb7M_uWyWL-FETxKYesvGZLLIEXFa50N4Ft2NLHx4HFgeKPqVA0PjA89mr7JHFkWHsdiWOVmMaAQDslKaJy3YvoNQ25S_YnpMaqQAZTwMZPwfCrsSzDp8pXvGprpiXxhNPsuXXj_F-bIqcjNmkc8kHEI0-A0jLCjiBA5AIXrs5czeWVmZ4GiKC1w_jPm00sN4UZqps9IdLbg2WHF8etw7_nALvGb96fnma4PKb5_z0RUhyaWuPFA9GIsXp2NY68r6kUwX7AQkfwRV6QoREdqBGDhBTBkZPxjXpy7ldxpEICRaKpLHSS6c8s4lQKkAObSX9FrY-3zLDrRXmb3USLNj58vKs93iRy7Ney8VLXvMKVm88g0GlrGbsE5JghPmEMBcPNwhCoMUu0-LGMiTEomvoi2jrQBFXX0IegQdArxOgPLCnCkQ9Uj7wytKNPLMzU9E7p1qEttTLCOkNpyeBLFWuUVdi8pohvayVocImB4AkJi7iReoDoIRL5EgtgHuTwA00nB1YGMm6z5GrbOnooNwU0F8nNhHkhgta1lhUjmx2qwO2Hi3TaRXxByChKpCsseoqP1UqZMayDSIawLhp8ZeopjUkR4tRDXFSxXDB0p_buGiycTowNxFqxFE15QDmcQSAjTUHj6xpam4nWtOpauP7ZesXTZMoT5ROOeIoRxK7PxpU9OuYLfpnyO_RVxM_V_rkglIFMZ_iYRUPCJufhM1_dytJ0sZf3AsVtVLsh1gmvanF3s73iDVEnPP8bO5g-tPAeI_-AIuSWuPcIz73Lc6N9WsqK7-uCCBhYu6w8-MpsVPjNJYlofBUbBaSeBOlPgSw11iC_kSb3HFLl7YJr9cUltSMBZingBmq_ZSLVmrCSnmuOorJXiZh14Hnbui7ZsDBlGSznK07tkPQWz753U1tQb_TFPTZrOGwaMj_3W7lHW_0C8Q0FseOiP7C794H7w9HflNsb2-LvhiJB2JnKRLGSuaZaeClFKyIDcWdVWremgoI0AOGpmyggJVef7dL4L7b3dnpBH-3pka0Ac2HtWh2V6VRksaPFBo5W3IrnLebkqixM9DLjoWHm7h9QduVBRMIQa6plmUqFbouov2OvN4APE4atHiMdkjZ9m0ghEcBrpCBh-v22Rb0HnpFtaEfaxgkCRlQFIgloRBUGUW4NYNClfuh6boeP30s-Se00sOmyii6tumrU5I6dIOVC80wGj4KLuJIQLXUjBZxQx_2NNzpUziPSGM0uDNJqgvlHC8RmxT2pqF5yjgX_b7SOvWXn6autDU1JfRCRHxcGxF710eEQ1JYhMONkaFCsxCrp1UjGMqtMlriykFIQzYDFF5Qa8tZTdqGkdEldeM4WbRmWxxXUVmmBo0SnzeSZSkf7MVY3JgnLm0bN9hYiNEFCn4NFEyl964r0bKlMMiQRHQwySEkvo6QJFvYjZRyy5stdaF9W5QWG3-OPW7mhSOV32wqEFKwWvcFDVmYyoZNcUtI55qyZjnth4BFNST9ImjvyZQWPeSiUz2rCtxQ8Z0CFKmMOOFRVKObcguGzUv4DJHO4krde6HkpDs_UTlp3PaKKl7Nm-wrcXBw_WxqMg1EU7QZ1MSlhHpI58U7h6l2Yx7sHF8vyLS4D42oa_jbOdZoR4VtKPl7MZHQ6-gvyQlWUe9ACkU1gtKRpdy3FwPhZuD09JIqUkfJDw6Wp8HFweRaG_o8KkJGagzGpFlzbyOWuF_Fa1PCv-5KnMROQfrz5U7hwIMwmhvQ9qiLfvBnG-XJ0TkmuYxmYO5aaC4IkVpKi1Ef-DCa8QfJ_rlodWdSDNOUrvFonSsZR3uygL-b33Lws9YbFKCSOo1cUzV1Y_IyxRgf9NYEuS85TVnf5l0V8Ughj-03XEukZAywkGQE3WKnASKFthonkviulmSqyScoUBQbFBoHqXx3K3TI_zfUukNW4jAWxlIMR-dWTiRHOJpybJUE0s9q9Z_E-QOxgaUb4hbpLOg3Jfq_XOVscaA3XAcgq_rIGbT_-hPzvOXo-oCbS5uAxl1dGgW-fCoVjy-sfHp0erqLtdxYQjvnMhuFCd5cEejYZnObir23O6ZMKALn4bfGjq-AT6D2yIBcZVS_ILdDT8ey6H8FoI7L37wJrRb1Wk_pXmM9AURVPLe_BuHNfRn36l9qyESnGwulL8Fl7y4NIHPk7959M_Ld5dkiHcoz6Nf1ajdBXmnablqcLolj39YuWG7caKcbN1rj5Q8fruGKEuJadsQN9ARRJY5gW2o1Ue5LhYCM0yUauDXb3sa2XtHMbPiGd03IdC04PWULHj2K4yYkclnol69kY8SlS9ktvpTlyta9DOUbxlBJsm5hYNmeKrpMhAg2vtB0o8yvi3SHHEE9fhxBKZ0sVLXTBeoB0kKs9oMQA11svWwrUluF5nIQmtm5xrs2h00Sn4VbukVEh4c3INq9FtHpNyKKAbAW0pMnAdJv6LaWPfd8Cw-VHXExiye3VwXzSXKOqjJ8h0ddFEp2F2M7gUtddMKHgTCOp3_gRpuvP8P959HR2oH1KAzkz561IwG0-c-dWgOk4-PrEP09uf4VJ9cYqM-fXxcWf5HxNfLw4kVngCUm_p5hv32GXZLMl_QXJvOBtvt3JfEvS1611aoTjH9WCY2gXr--GdT_uYpGVB8_zqvoUrj-7wtpr98rFYJc57393uVZJcRZD2tIW_bxY66GEgl91jurPmOpbLx5O6uy3r63jer3mjpHtB1qOUJ72NsfysLhqcq1N_ZV-KcT_C8o-r1aVr8aU6YP8cfe_mXvore_s31_9_ade3v3dnbv7d6798OPP_Z7s97-7Z0723fv3L__w97dvbv379ze_dzvfeINdj__F43A6o4?type=png)](https://mermaid.live/edit#pako:eNrtWv1zFDcS_VdUW0nZVK1dtgkEXEcog8GYz5wxAXK-utLOaHcVz4wmkmbXi83_fq9b0uzshw0V6i4_JJUimBmN9Pp19-tuwWUvM7nq7ffOqpGV9VicHp5V-M8f_Ousd2jEzDRiLCdKSJGZsi7UhXCSfheusRM1E7lyelQJM_hNZV5kVkmvcjHVfiwU_qescJNZWLR5Sxj6o1V1--DhWe_fdBwfKba2fhJXr82VeITTTyR_7seywtkVDuvT707n_FSJQqpzVdGeE2nz2uCHE1HogZVWK7e68UflrsRj7PzeNEXOphX6XAlvxES7Rhb6kxK6Ur_Tj37Whfa4s8MhdoBNhbGq-gQTamsmwORAkfNW6tHYD42dApJgSnUmzFCMzfQfA_sTDrWiNnVTSK9NRW905ZVVzotcD4fKOjG0phS1skNiNKFZBUM8PQGWA6uCLcac62okcDhByYBPbDpd6kJaspEoG-lKg0Q1HOpMq8rfIkxwbGmqYiYaB9cNZkCER4rIzrDGBqSAqKTN4BLXp68GjSffeFGSxaIyXgyUUNJp2qmCk5w3hvfjk1WlrCxE3QwKnXW5fZLM6YtjUSlAcB5HOq8zR7hBbWb1gEKwQ5y6qLGP9jgMaySCYSZkk8OoTF2Jpx1e1IUsYTaYqc1EWT-jiFl185PWxYRDlkt8UvRbNVaIP2RDCTsb7M_uWyWL-FETxKYesvGZLLIEXFa50N4Ft2NLHx4HFgeKPqVA0PjA89mr7JHFkWHsdiWOVmMaAQDslKaJy3YvoNQ25S_YnpMaqQAZTwMZPwfCrsSzDp8pXvGprpiXxhNPsuXXj_F-bIqcjNmkc8kHEI0-A0jLCjiBA5AIXrs5czeWVmZ4GiKC1w_jPm00sN4UZqps9IdLbg2WHF8etw7_nALvGb96fnma4PKb5_z0RUhyaWuPFA9GIsXp2NY68r6kUwX7AQkfwRV6QoREdqBGDhBTBkZPxjXpy7ldxpEICRaKpLHSS6c8s4lQKkAObSX9FrY-3zLDrRXmb3USLNj58vKs93iRy7Ney8VLXvMKVm88g0GlrGbsE5JghPmEMBcPNwhCoMUu0-LGMiTEomvoi2jrQBFXX0IegQdArxOgPLCnCkQ9Uj7wytKNPLMzU9E7p1qEttTLCOkNpyeBLFWuUVdi8pohvayVocImB4AkJi7iReoDoIRL5EgtgHuTwA00nB1YGMm6z5GrbOnooNwU0F8nNhHkhgta1lhUjmx2qwO2Hi3TaRXxByChKpCsseoqP1UqZMayDSIawLhp8ZeopjUkR4tRDXFSxXDB0p_buGiycTowNxFqxFE15QDmcQSAjTUHj6xpam4nWtOpauP7ZesXTZMoT5ROOeIoRxK7PxpU9OuYLfpnyO_RVxM_V_rkglIFMZ_iYRUPCJufhM1_dytJ0sZf3AsVtVLsh1gmvanF3s73iDVEnPP8bO5g-tPAeI_-AIuSWuPcIz73Lc6N9WsqK7-uCCBhYu6w8-MpsVPjNJYlofBUbBaSeBOlPgSw11iC_kSb3HFLl7YJr9cUltSMBZingBmq_ZSLVmrCSnmuOorJXiZh14Hnbui7ZsDBlGSznK07tkPQWz753U1tQb_TFPTZrOGwaMj_3W7lHW_0C8Q0FseOiP7C794H7w9HflNsb2-LvhiJB2JnKRLGSuaZaeClFKyIDcWdVWremgoI0AOGpmyggJVef7dL4L7b3dnpBH-3pka0Ac2HtWh2V6VRksaPFBo5W3IrnLebkqixM9DLjoWHm7h9QduVBRMIQa6plmUqFbouov2OvN4APE4atHiMdkjZ9m0ghEcBrpCBh-v22Rb0HnpFtaEfaxgkCRlQFIgloRBUGUW4NYNClfuh6boeP30s-Se00sOmyii6tumrU5I6dIOVC80wGj4KLuJIQLXUjBZxQx_2NNzpUziPSGM0uDNJqgvlHC8RmxT2pqF5yjgX_b7SOvWXn6autDU1JfRCRHxcGxF710eEQ1JYhMONkaFCsxCrp1UjGMqtMlriykFIQzYDFF5Qa8tZTdqGkdEldeM4WbRmWxxXUVmmBo0SnzeSZSkf7MVY3JgnLm0bN9hYiNEFCn4NFEyl964r0bKlMMiQRHQwySEkvo6QJFvYjZRyy5stdaF9W5QWG3-OPW7mhSOV32wqEFKwWvcFDVmYyoZNcUtI55qyZjnth4BFNST9ImjvyZQWPeSiUz2rCtxQ8Z0CFKmMOOFRVKObcguGzUv4DJHO4krde6HkpDs_UTlp3PaKKl7Nm-wrcXBw_WxqMg1EU7QZ1MSlhHpI58U7h6l2Yx7sHF8vyLS4D42oa_jbOdZoR4VtKPl7MZHQ6-gvyQlWUe9ACkU1gtKRpdy3FwPhZuD09JIqUkfJDw6Wp8HFweRaG_o8KkJGagzGpFlzbyOWuF_Fa1PCv-5KnMROQfrz5U7hwIMwmhvQ9qiLfvBnG-XJ0TkmuYxmYO5aaC4IkVpKi1Ef-DCa8QfJ_rlodWdSDNOUrvFonSsZR3uygL-b33Lws9YbFKCSOo1cUzV1Y_IyxRgf9NYEuS85TVnf5l0V8Ughj-03XEukZAywkGQE3WKnASKFthonkviulmSqyScoUBQbFBoHqXx3K3TI_zfUukNW4jAWxlIMR-dWTiRHOJpybJUE0s9q9Z_E-QOxgaUb4hbpLOg3Jfq_XOVscaA3XAcgq_rIGbT_-hPzvOXo-oCbS5uAxl1dGgW-fCoVjy-sfHp0erqLtdxYQjvnMhuFCd5cEejYZnObir23O6ZMKALn4bfGjq-AT6D2yIBcZVS_ILdDT8ey6H8FoI7L37wJrRb1Wk_pXmM9AURVPLe_BuHNfRn36l9qyESnGwulL8Fl7y4NIHPk7959M_Ld5dkiHcoz6Nf1ajdBXmnablqcLolj39YuWG7caKcbN1rj5Q8fruGKEuJadsQN9ARRJY5gW2o1Ue5LhYCM0yUauDXb3sa2XtHMbPiGd03IdC04PWULHj2K4yYkclnol69kY8SlS9ktvpTlyta9DOUbxlBJsm5hYNmeKrpMhAg2vtB0o8yvi3SHHEE9fhxBKZ0sVLXTBeoB0kKs9oMQA11svWwrUluF5nIQmtm5xrs2h00Sn4VbukVEh4c3INq9FtHpNyKKAbAW0pMnAdJv6LaWPfd8Cw-VHXExiye3VwXzSXKOqjJ8h0ddFEp2F2M7gUtddMKHgTCOp3_gRpuvP8P959HR2oH1KAzkz561IwG0-c-dWgOk4-PrEP09uf4VJ9cYqM-fXxcWf5HxNfLw4kVngCUm_p5hv32GXZLMl_QXJvOBtvt3JfEvS1611aoTjH9WCY2gXr--GdT_uYpGVB8_zqvoUrj-7wtpr98rFYJc57393uVZJcRZD2tIW_bxY66GEgl91jurPmOpbLx5O6uy3r63jer3mjpHtB1qOUJ72NsfysLhqcq1N_ZV-KcT_C8o-r1aVr8aU6YP8cfe_mXvore_s31_9_ade3v3dnbv7d6798OPP_Z7s97-7Z0723fv3L__w97dvbv379ze_dzvfeINdj__F43A6o4)


Individuals getting started in the field of poverty and inequality statistics might find the number of techniques described in this textbook overwhelming, especially choosing which method might be most appropriate for each particular research question.  The authors of this textbook consider Dr. Ija Trapeznikova's article [Measuring income inequality](https://wol.iza.org/articles/measuring-income-inequality/long) an important summary of how to approach selecting between available techniques.




## Installation {#install}

In order to work with the `convey` library, you will need to have R running on your machine.  If you have never used R before, you will need to [install that software](https://www.r-project.org/) before `convey` can be accessed.  Once you have R loaded on your machine, you can install..

* the latest released version from [CRAN](https://CRAN.R-project.org/package=convey) with

```R
install.packages("convey")
```

* the latest development version from github with

```R
remotes::install_github("ajdamico/convey")
```

In order to know how to cite this package, run `citation("convey")`.

## Complex surveys and statistical inference {#survey}

In this book, we demonstrate how to measure poverty and income concentration in a population based on microdata collected from a complex survey sample.  Most surveys administered by government agencies or larger research organizations utilize a sampling design that violates the assumption of simple random sampling (SRS), including:

1. Different units selection probabilities;
2. Clustering of units;
3. Stratification of clusters;
4. Reweighting to compensate for missing values and other adjustments.

Therefore, basic unweighted R commands such as `mean()` or `glm()` will not properly account for the weighting nor the measures of uncertainty (such as the confidence intervals) present in the dataset.  For some examples of publicly-available complex survey data sets, see [http://asdfree.com]().  

Unlike other software, the R `convey` package does not require that the user specify these parameters throughout the analysis.  So long as the [svydesign object](http://r-survey.r-forge.r-project.org/survey/html/svydesign.html) or [svrepdesign object](http://r-survey.r-forge.r-project.org/survey/html/svrepdesign.html) has been constructed properly at the outset of the analysis, the `convey` package will incorporate the survey design automatically and produce statistics and variances that take the complex sample into account.

Survey analysts familiar with the R `dplyr` syntax implemented by the `survey` library's wrapper `srvyr` package might be interested in implementing specific `convey` functions by following the [`svygini()` example](http://gdfe.co/srvyr/articles/extending-srvyr.html) published by `srvyr` author Greg Freedman Ellis.  Note that the full design stored by `convey_prep()` may in some cases complicate this extension.



## Variance Estimation: Linearization and Replication-Based Methods 

### Linearized Designs



### Replication Designs

All major functions in the `convey` library have S3 methods  for the classes: `survey.design`, `svyrep.design` and `DBIdesign`. When the argument `design` is  a survey design with replicate weights created by the `survey` library, `convey` uses the method `svrepdesign`. 

Considering the remarks in [@W85],  p. 163, concerning the deficiency of the `Jackknife` method in estimating the variance of `quantiles`, we adopted the bootstrap method instead. 

The function `bootVar` from the `laeken` library [@R-laeken], also uses the bootstrap method to estimate variances. 


## Usage Examples


In the following example, we've loaded the data set `eusilc` from the R library [laeken](https://CRAN.R-project.org/package=laeken) [@R-laeken].

```{r results='hide', message=FALSE, warning=FALSE}
library(laeken)
data(eusilc)
```
Next, we create an object of class `survey.design` using the function `svydesign` of the `survey` library:

```{r results='hide', message=FALSE, warning=FALSE}
library(survey)
des_eusilc <-
  svydesign(
    ids = ~ rb030,
    strata =  ~ db040,
    weights = ~ rb050,
    data = eusilc
  )
```
Right after the creation of the design object `des_eusilc`, we should use the function `convey_prep` that adds an attribute to the survey design which saves information on the design object based upon the whole sample, needed to work with subset designs.

```{r}
library(convey)
des_eusilc <- convey_prep(des_eusilc)
```
To estimate the at-risk-of-poverty rate, we use the function `svyarpt`:

```{r comment=NA}
svyarpr( ~ eqIncome, design = des_eusilc)
```
To estimate the at-risk-of-poverty rate across domains defined by the variable `db040` we use:

```{r comment=NA}
svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc,
  FUN = svyarpr,
  deff = FALSE
)
```

Using the same data set, we estimate the quintile share ratio: 

```{r comment=NA}
# for the whole population
svyqsr( ~ eqIncome, design = des_eusilc, alpha1 = .20)

# for domains
svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc,
  FUN = svyqsr,
  alpha1 = .20,
  deff = FALSE
)
```

These functions can be used as S3 methods for the classes `survey.design` and `svyrep.design`.

Let's create a design object of class `svyrep.design` and run the function `convey_prep` on it:

```{r}
des_eusilc_rep <- as.svrepdesign(des_eusilc, type = "bootstrap")
des_eusilc_rep <- convey_prep(des_eusilc_rep)
```

The function `svyarpr` produces matching coefficients and near-identical standard errors on the replication design:

```{r comment=NA}
svyarpr( ~ eqIncome, design = des_eusilc_rep)

svyby(
  ~ eqIncome,
  by = ~ db040,
  design = des_eusilc_rep,
  FUN = svyarpr,
  deff = FALSE
)
```
The functions of the convey `library` are called in a similar way  to the functions in `survey` library.

It is also possible to deal with missing values by using the argument `na.rm`.

```{r comment=NA}
# survey.design using a variable with missings
svygini( ~ py010n , design = des_eusilc)
svygini( ~ py010n , design = des_eusilc , na.rm = TRUE)

# svyrep.design using a variable with missings
svygini( ~ py010n , design = des_eusilc_rep)
svygini( ~ py010n , design = des_eusilc_rep , na.rm = TRUE)
```
